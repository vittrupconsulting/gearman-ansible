#!/usr/bin/python3

import sys
import gear
import json
import socket

client = gear.Client()
for server in {{ groups['gearman-server'] | shuffle(seed=ansible_hostname) }}:
    client.addServer(f"{server}", 4730)

try:
    client.waitForServer(60)
    payload = {}
    payload["source"] = socket.gethostname()
    job = gear.Job("ansible", bytes(json.dumps(payload), 'utf-8'))
    client.submitJob(job)
except TimeoutError:
    sys.exit(1)
else:
    sys.exit(0)
